# ğŸ³ Kafka Ingestion Layer Makefile
-include .env.secrets

COMPOSE=docker-compose
PYTHON=python3
PROJECT_DIR=$(shell pwd)
TOPIC?=users

.PHONY: help start stop restart logs status create-topics consume produce

# ğŸ”¹ Show help menu
help:
	@echo "Kafka Ingestion Layer Commands:"
	@echo ""
	@echo "  make start              - Start Kafka + Zookeeper"
	@echo "  make stop               - Stop all containers"
	@echo "  make restart            - Restart Kafka stack"
	@echo "  make logs               - View live Kafka logs"
	@echo "  make status             - Show container status"
	@echo "  make create-topics      - Run the topic creation script"
	@echo "  make consume-topic      - Run test Kafka consumer (requires TOPIC=...)"
	@echo "  make produce-topic      - Run test Kafka producer (requires TOPIC=...)"
	@echo "  make ps                 - Alias for docker-compose ps"
	@echo "  make nuke               - Remove all containers, volumes, and networks ğŸ’£"

# ğŸ”¹ Start Kafka and Zookeeper
start:
	@echo "ğŸš€ Starting Kafka stack..."
	$(COMPOSE) up -d

# ğŸ”¹ Stop Kafka and Zookeeper
stop:
	@echo "ğŸ›‘ Stopping Kafka stack..."
	$(COMPOSE) down

# ğŸ”¹ Stop and remove all containers + volumes
nuke:
	@echo "ğŸ’£ Stopping and removing containers, volumes, and networks..."
	$(COMPOSE) down -v

# ğŸ”¹ Restart containers
restart: stop start

# ğŸ”¹ Tail logs
logs:
	@echo "ğŸ“œ Showing Kafka logs..."
	$(COMPOSE) logs -f kafka

# ğŸ”¹ Show container status
status ps:
	@echo "ğŸ“¦ Kafka container status:"
	$(COMPOSE) ps

# ğŸ”¹ Create topics using script
create-topics:
	@echo "ğŸ§± Creating Kafka topics..."
	$(PYTHON) topics/create_topics.py

# ğŸ”¹ Run Kafka Consumer for a specific topic
consume-topic:
	@echo "ğŸ“¥ Consuming from topic: $(TOPIC)"
	$(PYTHON) consumer/test_consumer.py --topic $(TOPIC)

# ğŸ”¹ Run Kafka Producer (optional)
produce-topic:
	@echo "ğŸ“¤ Producing test data to topic: $(TOPIC)"
	$(PYTHON) producer/produce_topic.py --topic $(TOPIC)

# ğŸ”¹ Kafka Consumer Docker Build & Run
# ğŸ”¹ Build Kafka Consumer Image
login:
	docker login -u $(DOCKERHUB_USERNAME) -p $(DOCKERHUB_PASSWORD)

build-consumer:
	@echo "ğŸ³ Building Kafka consumer image..."
	docker build -t ecom_kafka_consumer:latest ./consumer

push: build-consumer
	docker tag ecom_kafka_consumer:latest  tejasjay03/ecom_kafka_consumer:latest 
	docker push tejasjay03/ecom_kafka_consumer:latest 

# ğŸ”¹ Run Kafka Consumer Container
run-consumer:
	@echo "ğŸ“¦ Running Kafka consumer container..."
	docker run --rm \
		-e TOPIC=$(TOPIC) \
		-e BOOTSTRAP=host.docker.internal:9092 \
		ecom_kafka_consumer:latest

